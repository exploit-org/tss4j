package org.exploit.threshield.frost.signature;

import org.exploit.gmp.BigInt;
import org.exploit.threshield.curve.PointOps;
import org.exploit.threshield.frost.context.FrostContext;
import org.exploit.threshield.frost.model.ParticipantCommitment;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;

import static org.exploit.threshield.frost.hash.FrostHash.H1;
import static org.exploit.threshield.frost.hash.FrostHash.H2;

public class FrostPartialSignatureClient<P extends PointOps<P>> {
    private final FrostContext<P> context;

    public FrostPartialSignatureClient(FrostContext<P> context) {
        this.context = context;
    }

    public void storeCommitment(int idx, String opId, ParticipantCommitment<P> commitment) {
        context.commitment().storePeerCommitment(idx, opId, commitment);
    }

    public PointOps<P> computeR(String opId) {
        var q = context.crypto().curve().getCurveOrder();
        var B = collectPeerCommitments(opId);

        var R = context.crypto().curve().getInfinity();

        for (var pc : B) {
            var rho_j = H1(pc.idx(), context.message(opId), B, q);
            var term = pc.D().add(pc.E().mul(rho_j));
            R = R.add(term);
        }

        return R.normalize();
    }

    public BigInt computeZ(String opId) {
        var q = context.crypto().curve().getCurveOrder();
        var idx = context.crypto().idx();
        var rho_i = H1(idx, context.message(opId), collectPeerCommitments(opId), q);

        var R = computeR(opId);
        var c = H2(R, context.crypto().Y(), context.message(opId), q);

        var pair = context.commitment().pair(opId);
        var d_i = pair.d();
        var e_i = pair.e();

        return context.crypto().useLagrangeShare(share -> d_i.add(e_i.multiply(rho_i)).add(share.multiply(c)).mod(q));
    }

    public List<ParticipantCommitment<P>> collectPeerCommitments(String opId) {
        var peers = context.commitment().getPeerCommitments(opId);

        List<ParticipantCommitment<P>> B = new ArrayList<>(peers);
        B.sort(Comparator.comparingInt(ParticipantCommitment::idx));

        return B;
    }
}
