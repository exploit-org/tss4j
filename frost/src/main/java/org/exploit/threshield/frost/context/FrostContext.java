package org.exploit.threshield.frost.context;

import lombok.Builder;
import org.exploit.threshield.curve.PointOps;
import org.exploit.threshield.frost.context.commitment.CommitmentContext;
import org.exploit.threshield.frost.context.commitment.InMemoryCommitmentContext;
import org.exploit.threshield.frost.context.crypto.CryptoContext;
import org.exploit.threshield.frost.context.signature.InMemorySignatureAggregatorContext;
import org.exploit.threshield.frost.context.signature.SignatureAggregatorContext;

import javax.security.auth.Destroyable;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

@Builder(builderMethodName = "newBuilder")
public final class FrostContext<P extends PointOps<P>> implements Destroyable {
    private final Map<String, byte[]> operations;
    private final CryptoContext<P> crypto;

    private CommitmentContext<P> commitment;
    private SignatureAggregatorContext aggregator;

    private FrostContext(Map<String, byte[]> operations, CryptoContext<P> crypto, CommitmentContext<P> commitment, SignatureAggregatorContext aggregator) {
        this.operations = operations;
        this.commitment = commitment;
        this.crypto = crypto;
        this.aggregator = aggregator;
    }

    public byte[] message(String opId) {
        return operations.get(opId);
    }

    public CommitmentContext<P> commitment() {
        return commitment;
    }

    public CryptoContext<P> crypto() {
        return crypto;
    }

    public SignatureAggregatorContext aggregator() {
        return aggregator;
    }

    public static <P extends PointOps<P>> Builder<P> newBuilder(Class<P> ignore) {
        return new Builder<>();
    }

    @Override
    public void destroy() {
        crypto.destroy();
    }

    public static class Builder<P extends PointOps<P>> {
        private Map<String, byte[]> operations = new HashMap<>();
        private CryptoContext<P> crypto;

        private CommitmentContext<P> commitment = new InMemoryCommitmentContext<>();
        private SignatureAggregatorContext aggregator = new InMemorySignatureAggregatorContext();

        public Builder<P> message(String opId, byte[] message) {
            operations.put(Objects.requireNonNull(opId), Objects.requireNonNull(message));
            return this;
        }

        public Builder<P> operations(Map<String, byte[]> operations) {
            this.operations = Objects.requireNonNull(operations);
            return this;
        }

        public Builder<P> crypto(CryptoContext<P> crypto) {
            this.crypto = crypto;
            return this;
        }

        public Builder<P> commitment(CommitmentContext<P> commitment) {
            this.commitment = commitment;
            return this;
        }

        public Builder<P> aggregator(SignatureAggregatorContext aggregator) {
            this.aggregator = aggregator;
            return this;
        }

        public FrostContext<P> build() {
            if (commitment == null)
                commitment = new InMemoryCommitmentContext<>();

            if (aggregator == null)
                aggregator = new InMemorySignatureAggregatorContext();

            if (operations == null || operations.isEmpty())
                throw new IllegalArgumentException("Operations cannot be null or empty");

            return new FrostContext<>(
                operations,
                Objects.requireNonNull(crypto),
                commitment, aggregator
            );
        }
    }
}
