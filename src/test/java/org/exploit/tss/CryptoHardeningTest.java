package org.exploit.tss;

import org.exploit.gmp.BigInt;
import org.exploit.tss.mta.MtAProtocol;
import org.exploit.tss.pallier.Paillier;
import org.exploit.tss.pallier.key.PaillierKeyPair;
import org.exploit.tss.proof.model.ZKSetup;
import org.exploit.tss.util.BigIntUtils;
import org.exploit.tss.util.Bytes;
import org.exploit.tss.util.Hash;
import org.exploit.tss.util.ZKRandom;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.util.Arrays;

import static org.junit.jupiter.api.Assertions.*;

class CryptoHardeningTest {
    private static final BigInt CURVE_ORDER;

    private PaillierKeyPair kp;
    private Paillier paillier;

    static {
        TSS.loadLibraries();
        CURVE_ORDER = new BigInt("FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141",16);
    }

    @BeforeEach
    void init() {
        kp = Paillier.generateKeyPair(3072);
        paillier  = new Paillier(kp);
    }

    @Test
    void randomZnStar_coprime() {
        var n = kp.publicKey().nsquare();
        var rnd = BigIntUtils.randomZnStar(n, ZKRandom.getRandom());
        assertEquals(BigInt.ONE, rnd.gcd(n),
                     "randomZnStar must return element in Z_n*");
    }

    @Test
    void bytesEncode_noAmbiguity() {
        var x1 = "ab$".getBytes();
        var x2 = "cd".getBytes();

        var y1 = "ab".getBytes();
        var y2 = "$cd".getBytes();

        var h1 = Hash.sha256(Bytes.encode(x1,x2));
        var h2 = Hash.sha256(Bytes.encode(y1,y2));

        assertFalse(Arrays.equals(h1,h2),
                    "Length-prefixed encoding must differ for ambiguous splits");
    }

    @Test
    void initiatorMessage_fullVerification() {
        var proto = new MtAProtocol(paillier, CURVE_ORDER);
        var zk = ZKSetup.generate(2048);
        var ctx = "init_test".getBytes();

        var a_i = BigInt.valueOf(42);
        var msg = proto.generateInitiatorMessage(a_i, zk, ctx);

        assertTrue(proto.verifyInitiatorRangeProof(msg, paillier.publicKey(), zk, ctx));
        assertTrue(proto.verifyInitiatorBiPrimeProof(msg, paillier.publicKey(), ctx));
    }
}