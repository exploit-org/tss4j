package org.exploit.tss.proof.paillier;

import org.exploit.tss.util.Hash;
import org.exploit.gmp.BigInt;
import org.exploit.tss.proof.ZKProofGenerator;
import org.exploit.tss.proof.model.PaillierRangeProof;
import org.exploit.tss.proof.model.witness.PaillierRangeEncryptionWitness;
import org.exploit.tss.util.Bytes;
import org.exploit.tss.util.ZKRandom;

import static org.exploit.tss.util.BigIntUtils.randomZnStar;

public class PaillierRangeProofGenerator implements ZKProofGenerator<PaillierRangeProof, PaillierRangeEncryptionWitness, byte[]> {
    @Override
    public PaillierRangeProof createProof(PaillierRangeEncryptionWitness witness, byte[] context) {
        var pubKey = witness.publicKey();
        var zkSetup = witness.zk();

        var g = pubKey.g();
        var n = pubKey.n();
        var nsq = pubKey.nsquare();
        var hatN = zkSetup.hatN();
        var h1 = zkSetup.h1();
        var h2 = zkSetup.h2();

        var q = witness.q();
        var q2 = q.pow(2);

        var alpha = randomZnStar(q2, ZKRandom.getRandom());
        var beta = randomZnStar(n, ZKRandom.getRandom());
        var gamma = randomZnStar(q2.multiply(hatN), ZKRandom.getRandom());
        var rho = randomZnStar(q.multiply(hatN), ZKRandom.getRandom());

        var z = h1.modPow(witness.m(), hatN).multiply(h2.modPow(rho, hatN)).mod(hatN);
        var u = g.modPow(alpha, nsq).multiply(beta.modPow(n, nsq)).mod(nsq);

        var w = h1.modPow(alpha, hatN).multiply(h2.modPow(gamma, hatN)).mod(hatN);

        var hashInput = Bytes.encode(
            witness.c().toByteArray(),
            z.toByteArray(),
            u.toByteArray(),
            w.toByteArray(),
            context
        );

        var e = new BigInt(1, Hash.sha256(hashInput)).mod(q);

        var s = witness.r().modPow( e, n).multiplySec(beta).mod(n);
        var s1 = e.multiplySec(witness.m()).add(alpha);
        var s2 = e.multiplySec(rho).add(gamma);

        return new PaillierRangeProof(
            z.toByteArray(), u.toByteArray(),
            w.toByteArray(), s.toByteArray(),
            s1, s2
        );
    }
}