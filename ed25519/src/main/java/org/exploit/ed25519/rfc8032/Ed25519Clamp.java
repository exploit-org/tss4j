package org.exploit.ed25519.rfc8032;

import org.exploit.crypto.Hash;
import org.exploit.crypto.key.ed25519.Ed25519PrivateKey;
import org.exploit.ed25519.Ed25519CurveParams;
import org.exploit.gmp.BigInt;
import org.owasp.netryx.memory.SecureMemory;

import java.util.Arrays;

public final class Ed25519Clamp {
    private Ed25519Clamp() {}

    public static BigInt toBigInt(Ed25519PrivateKey privateKey) {
        return toBigInt(privateKey.encoded());
    }

    public static BigInt toBigInt(SecureMemory seed) {
        return seed.deobfuscate(Ed25519Clamp::toBigInt);
    }

    public static BigInt toBigInt(byte[] bytes) {
        var h = Hash.sha512(bytes);

        h[0]  &= (byte)0xF8;
        h[31] &= (byte)0x7F;
        h[31] |= (byte)0x40;

        var scalarLE = Arrays.copyOf(h, 32);

        for (var i = 0; i < 16; i++) {
            var tmp = scalarLE[i];
            scalarLE[i] = scalarLE[31 - i];
            scalarLE[31 - i] = tmp;
        }

        return new BigInt(1, scalarLE).mod(Ed25519CurveParams.CURVE_ORDER);
    }
}
